---
name: code-review-expert
description: "以资深工程师的视角对当前 git 变更进行专业代码审查。检测 SOLID 违规、安全风险，并提出可操作的改进建议。"
---

# 代码审查专家

## 概述

对当前 git 变更执行结构化审查，重点关注 SOLID、架构、删除候选和安全风险。默认仅输出审查结果，除非用户要求实施更改。

## 严重性级别

| 级别 | 名称 | 描述 | 操作 |
|-------|------|-------------|--------|
| **P0** | 严重 | 安全漏洞、数据丢失风险、正确性错误 | 必须阻止合并 |
| **P1** | 高 | 逻辑错误、重大 SOLID 违规、性能退化 | 应在合并前修复 |
| **P2** | 中 | 代码异味、可维护性问题、轻微 SOLID 违规 | 在此 PR 中修复或创建后续任务 |
| **P3** | 低 | 风格、命名、小建议 | 可选改进 |

## 工作流程

### 1) 预检上下文

- 使用 `git status -sb`、`git diff --stat` 和 `git diff` 确定更改范围。
- 如需要，使用 `rg` 或 `grep` 查找相关模块、用法和契约。
- 识别入口点、所有权边界和关键路径（认证、支付、数据写入、网络）。

**边界情况：**
- **无更改**：如果 `git diff` 为空，通知用户并询问是否要审查暂存的更改或特定的提交范围。
- **大型差异（>500 行）**：首先按文件汇总，然后按模块/功能区域分批审查。
- **混合关注点**：按逻辑功能分组发现，而不仅仅是文件顺序。

### 2) SOLID + 架构异味

- 加载 `references/solid-checklist.md` 获取特定提示。
- 查找：
  - **SRP**：负载过重的模块，包含不相关的职责。
  - **OCP**：频繁编辑以添加行为，而不是扩展点。
  - **LSP**：破坏期望或需要类型检查的子类。
  - **ISP**：具有未使用方法的宽接口。
  - **DIP**：高级逻辑与低级实现绑定。
- 当您提出重构时，解释*为什么*它改善了内聚性/耦合性，并概述最小、安全的拆分。
- 如果重构不简单，提出增量计划而不是大型重写。

### 3) 删除候选 + 迭代计划

- 加载 `references/removal-plan.md` 获取模板。
- 识别未使用、冗余或功能标记关闭的代码。
- 区分**立即安全删除** vs **延迟删除计划**。
- 提供具体步骤和检查点（测试/指标）的后续计划。

### 4) 安全和可靠性扫描

- 加载 `references/security-checklist.md` 获取覆盖范围。
- 检查：
  - XSS、注入（SQL/NoSQL/命令）、SSRF、路径遍历
  - AuthZ/AuthN 漏洞、缺失租户检查
  - 日志/环境/文件中的密钥泄露或 API 密钥
  - 速率限制、无界循环、CPU/内存热点
  - 不安全的反序列化、弱加密、不安全的默认值
  - **竞态条件**：并发访问、检查后操作、TOCTOU、缺失锁
- 指出**可利用性**和**影响**。

### 5) 代码质量扫描

- 加载 `references/code-quality-checklist.md` 获取覆盖范围。
- 检查：
  - **错误处理**：吞咽异常、过于宽泛的捕获、缺失错误处理、异步错误
  - **性能**：N+1 查询、热路径中的 CPU 密集型操作、缺失缓存、无界内存
  - **边界条件**：null/undefined 处理、空集合、数值边界、差一错误
- 标记可能导致静默失败或生产事故的问题。

### 6) 输出格式

按以下方式组织您的审查：

```markdown
## 代码审查摘要

**审查文件**：X 个文件，Y 行更改
**总体评估**：[APPROVE / REQUEST_CHANGES / COMMENT]

---

## 发现

### P0 - 严重
（无或列表）

### P1 - 高
- **[文件:行]** 简短标题
  - 问题描述
  - 建议修复

### P2 - 中
...

### P3 - 低
...

---

## 删除/迭代计划
（如适用）

## 其他建议
（可选改进，不阻塞）
```

**内联注释**：对文件特定发现使用此格式：
```
::code-comment{file="path/to/file.ts" line="42" severity="P1"}
问题描述和建议修复。
::
```

**清洁审查**：如果未发现问题，明确说明：
- 检查了什么
- 任何未覆盖的领域（例如，"未验证数据库迁移"）
- 残留风险或建议的后续测试

### 7) 下一步确认

展示发现后，询问用户如何继续：

```markdown
---

## 下一步

我发现了 X 个问题（P0: _，P1: _，P2: _，P3: _）。

**您希望如何继续？**

1. **全部修复** - 我将实施所有建议的修复
2. **仅修复 P0/P1** - 处理严重和高优先级问题
3. **修复特定项目** - 告诉我要修复哪些问题
4. **不更改** - 审查完成，不需要实施

请选择一个选项或提供具体说明。
```

**重要**：在用户明确确认之前，不要实施任何更改。这是一个审查优先的工作流程。

## 资源

### references/

| 文件 | 目的 |
|------|---------|
| `solid-checklist.md` | SOLID 异味提示和重构启发式 |
| `security-checklist.md` | Web/应用安全和运行时风险检查清单 |
| `code-quality-checklist.md` | 错误处理、性能、边界条件 |
| `removal-plan.md` | 删除候选和后续计划模板 |
